<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×¡×§×¨×™× | ×“×£ ×‘×™×ª</title>
    <style>
        :root { --primary: #6366f1; --bg: #f1f5f9; --text: #1e293b; --danger: #ef4444; --accent: #8b5cf6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); direction: rtl; padding: 20px; margin: 0; }
        .container { max-width: 600px; margin: auto; }
        .category-header { background: var(--primary); color: white; padding: 10px 20px; border-radius: 12px; font-weight: bold; margin: 25px 0 15px 0; display: inline-block; }
        .survey-card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .opt-btn { width: 100%; text-align: right; padding: 12px; margin: 8px 0; border: 2px solid #f1f5f9; border-radius: 10px; cursor: pointer; background: #fff; transition: 0.2s; }
        .opt-btn.selected { background: var(--primary) !important; color: white; border-color: var(--primary); }
        .auth-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; margin-top: 10px; }
        #ban-screen { display:none; position:fixed; inset:0; background:white; z-index:10000; text-align:center; padding-top:100px; }
        
        /* ×¢×™×¦×•×‘ ×ª×™×‘×ª ×”×¨×¢×™×•× ×•×ª */
        .idea-card { background: white; padding: 20px; border-radius: 15px; margin-top: 30px; border: 2px dashed var(--accent); }
    </style>
</head>
<body>

    <div id="ban-screen">
        <h1 style="color:red">× ×—×¡××ª ××”××¢×¨×›×ª ğŸš«</h1>
        <p id="ban-reason"></p>
    </div>

    <div class="container">
        <div id="auth-ui" class="auth-card">
            <h2>×›× ×™×¡×” ×œ××¢×¨×›×ª ğŸ—³ï¸</h2>
            <input type="email" id="email" placeholder="××™××™×™×œ">
            <input type="password" id="pass" placeholder="×¡×™×¡××”">
            <button class="btn" style="background:var(--primary); color:white;" id="loginBtn">×›× ×™×¡×” / ×”×¨×©××”</button>
            <div style="margin: 20px 0; color: #666;">××•</div>
            <input type="tel" id="phone" placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ (9725...)">
            <div id="recaptcha-container"></div>
            <button class="btn" style="background:#10b981; color:white;" id="sendCodeBtn">×©×œ×— ×§×•×“ ×‘-SMS</button>
            <div id="verification-ui" style="display:none;">
                <input type="text" id="verificationCode" placeholder="×”×›× ×¡ ×§×•×“ ××™××•×ª">
                <button class="btn" style="background:#059669; color:white;" id="verifyCodeBtn">×××ª ×§×•×“</button>
            </div>
            <hr style="margin: 20px 0; border: 0.5px solid #eee;">
            <button class="btn" style="background:#fff; border: 1px solid #ddd; display:flex; align-items:center; justify-content:center; gap:10px;" id="googleBtn">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20"> ×”×ª×—×‘×¨ ×¢× Google
            </button>
        </div>

        <div id="app-ui" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:15px; border-radius:15px;">
                <span id="hello" style="font-weight:bold;"></span>
                <div style="display:flex; gap:10px;">
                    <a href="admin.html" id="adminBtn" style="display:none; background:#e0e7ff; color:#4338ca; padding:8px 15px; border-radius:8px; text-decoration:none; font-weight:bold;">× ×™×”×•×œ</a>
                    <button id="logoutBtn" class="btn" style="width:auto; margin:0; background:#fee2e2; color:#ef4444; padding:8px 15px;">×”×ª× ×ª×§</button>
                </div>
            </div>

            <div id="content-area"></div>

            <div class="idea-card">
                <h3 style="color:var(--accent); margin-top:0;">ğŸ’¡ ×™×© ×œ×›× ×¨×¢×™×•×Ÿ ×œ×¡×§×¨?</h3>
                <p style="font-size: 14px; color: #64748b;">×›×ª×‘×• ×œ× ×• ×”×¦×¢×” ×œ×¡×§×¨ ××¢× ×™×™×Ÿ ×•× ×©××— ×œ×”×•×¡×™×£ ××•×ª×•!</p>
                
                <textarea id="ideaText" placeholder="×œ××©×œ: ××™×–×” ×˜×¢× ×’×œ×™×“×” ×”×›×™ ×˜×¢×™×?"></textarea>
                <button class="btn" style="background:var(--accent); color:white;" id="sendIdeaBtn">×©×œ×— ×¨×¢×™×•×Ÿ ×œ×× ×”×œ</button>
            </div>

            <button class="btn" style="background:var(--danger); color:white; margin-top:40px; font-size: 12px;" id="deleteDataBtn">××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×©×œ×™ ğŸ—‘ï¸</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, RecaptchaVerifier, signInWithPhoneNumber, deleteUser, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, query, where, getDoc, serverTimestamp, getDocs, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyDe865bQUEQ_jbNeiXxCK4CfGM7n5Tx9-w", 
        authDomain: "surveyproject-3a831.firebaseapp.com", 
        projectId: "surveyproject-3a831", 
        storageBucket: "surveyproject-3a831.firebasestorage.app", 
        messagingSenderId: "734951066394", 
        appId: "1:734951066394:web:cb6ea73af396618c663aa3" 
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let confirmationResult = null;
    let userVotes = {};

    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });

    onAuthStateChanged(auth, async user => {
        if (user) {
            const banDoc = await getDoc(doc(db, "bans", user.uid));
            if(banDoc.exists()) {
                document.getElementById('ban-screen').style.display = 'block';
                document.getElementById('ban-reason').innerText = "×¡×™×‘×”: " + banDoc.data().reason;
                return;
            }
            document.getElementById('auth-ui').style.display = 'none';
            document.getElementById('app-ui').style.display = 'block';
            document.getElementById('hello').innerText = "×©×œ×•×, " + (user.displayName || user.email || user.phoneNumber);

            const adminDoc = await getDoc(doc(db, "admins", user.uid));
            if(adminDoc.exists()) document.getElementById('adminBtn').style.display = 'block';

            onSnapshot(query(collection(db, "votes"), where("uid", "==", user.uid)), s => {
                userVotes = {};
                s.forEach(d => userVotes[d.data().questionId] = d.data().vote);
                loadQuestions();
            });
        } else {
            document.getElementById('auth-ui').style.display = 'block';
            document.getElementById('app-ui').style.display = 'none';
        }
    });

    // ×¤×•× ×§×¦×™×™×ª ×©×œ×™×—×ª ×¨×¢×™×•×Ÿ
    document.getElementById('sendIdeaBtn').onclick = async () => {
        const text = document.getElementById('ideaText').value.trim();
        const user = auth.currentUser;
        if(!text) return alert("×× × ×›×ª×•×‘ ×¨×¢×™×•×Ÿ ×œ×¤× ×™ ×”×©×œ×™×—×”");
        
        await addDoc(collection(db, "suggestions"), {
            uid: user.uid,
            userName: user.displayName || user.email || user.phoneNumber,
            text: text,
            createdAt: serverTimestamp()
        });
        
        alert("×”×¨×¢×™×•×Ÿ × ×©×œ×— ×‘×”×¦×œ×—×”! ×ª×•×“×” :)");
        document.getElementById('ideaText').value = '';
    };

    function loadQuestions() {
        onSnapshot(collection(db, "question_bank"), s => {
            const area = document.getElementById('content-area');
            area.innerHTML = '';
            const questions = s.docs.map(d => ({id: d.id, ...d.data()}));
            const categories = [...new Set(questions.map(q => q.category || "×›×œ×œ×™"))];

            categories.forEach(cat => {
                area.innerHTML += `<div class="category-header">${cat}</div>`;
                questions.filter(q => (q.category || "×›×œ×œ×™") === cat).forEach(q => {
                    let optsHtml = q.options.map(opt => `
                        <button class="opt-btn ${userVotes[q.id] === opt ? 'selected' : ''}" 
                                onclick="window.vote('${q.id}', '${opt}')">${opt}</button>
                    `).join('');
                    area.innerHTML += `<div class="survey-card"><b>${q.text}</b><br>${optsHtml}</div>`;
                });
            });
        });
    }

    window.vote = async (qid, val) => {
        const user = auth.currentUser;
        if(!user) return;
        await setDoc(doc(db, "votes", user.uid + "_" + qid), {
            uid: user.uid, name: user.displayName || user.email || user.phoneNumber,
            questionId: qid, vote: val, createdAt: serverTimestamp()
        });
    };

    document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => window.location.reload());
    document.getElementById('googleBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
    document.getElementById('loginBtn').onclick = async () => {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        try { await signInWithEmailAndPassword(auth, e, p); } catch { await createUserWithEmailAndPassword(auth, e, p); }
    };
    document.getElementById('sendCodeBtn').onclick = async () => {
        confirmationResult = await signInWithPhoneNumber(auth, document.getElementById('phone').value, window.recaptchaVerifier);
        document.getElementById('verification-ui').style.display = 'block';
    };
    document.getElementById('verifyCodeBtn').onclick = async () => {
        await confirmationResult.confirm(document.getElementById('verificationCode').value);
    };

    document.getElementById('deleteDataBtn').onclick = async () => {
        if(confirm("××—×§ ××ª ×›×œ ×”×”×¦×‘×¢×•×ª ×•××ª ×”×—×©×‘×•×Ÿ ×œ×¦××™×ª×•×ª? [cite: 2025-12-17]")) {
            const user = auth.currentUser;
            const q = query(collection(db, "votes"), where("uid", "==", user.uid));
            const snap = await getDocs(q);
            const batch = writeBatch(db); // ×©×™××•×© ×‘-Batch ×œ××—×™×§×” ×™×¢×™×œ×”
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
            await deleteUser(user);
            alert("×›×œ × ×ª×•× ×™×š × ××—×§×• ××”××¢×¨×›×ª.");
        }
    };
</script>
</body>
</html>
