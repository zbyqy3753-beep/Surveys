<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×¡×§×¨×™× | ×“×£ ××©×ª××©</title>
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --danger: #ef4444; --success: #10b981; }
        body { font-family: sans-serif; background: var(--bg); direction: rtl; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 400px; margin: auto; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; background: var(--primary); color: white; margin-top: 10px; }
        .btn-danger { background: var(--danger); margin-top: 20px; }
        input { width:100%; padding:10px; margin:5px 0; border-radius:8px; border:1px solid #ddd; box-sizing: border-box; }
        #ban-screen { display:none; position:fixed; inset:0; background:white; z-index:10000; text-align:center; padding-top:100px; }
        .survey-card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #eee; }
        .opt-btn { width: 100%; text-align: right; padding: 12px; margin: 5px 0; border: 1px solid #e2e8f0; border-radius: 10px; cursor: pointer; background: #fff; }
        .opt-btn.selected { background: #6366f1 !important; color: white; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 20px; border-radius: 12px; margin-bottom: 20px; }
        #recaptcha-container { margin-top: 10px; }
    </style>
</head>
<body>

    <div id="ban-screen">
        <h1 style="color:red">×—×¡×•× ××”××¢×¨×›×ª ğŸš«</h1>
        <div id="ban-details"></div>
    </div>

    <div id="auth-ui" class="card">
        <h2>×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
        
        <input type="email" id="email" placeholder="××™××™×™×œ">
        <input type="password" id="pass" placeholder="×¡×™×¡××”">
        <button class="btn" id="loginBtn">×›× ×™×¡×” / ×”×¨×©××”</button>
        
        <hr>
        
        <input type="tel" id="phone" placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ (×œ××©×œ 972501234567+)">
        <div id="recaptcha-container"></div>
        <button class="btn" style="background:#2ecc71" id="sendCodeBtn">×©×œ×— ×§×•×“ ××™××•×ª ×‘-SMS</button>
        
        <div id="verification-ui" style="display:none; margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
            <input type="text" id="verificationCode" placeholder="×”×›× ×¡ ××ª ×”×§×•×“ ×©×§×™×‘×œ×ª">
            <button class="btn" style="background:#27ae60" id="verifyCodeBtn">×××ª ×§×•×“ ×•×›× ×¡</button>
        </div>

        <button class="btn" style="background:#4285F4" id="googleBtn">×›× ×™×¡×” ×¢× Google</button>
    </div>

    <div id="app-ui" style="display:none; max-width:500px; margin:auto;">
        <div class="nav-bar">
            <span id="hello"></span>
            <div style="display: flex; gap: 10px;">
                <button id="adminBtn" class="btn" style="width:auto; margin:0; padding:5px 15px; background:var(--primary); display:none;" onclick="window.location.href='admin.html'">× ×™×”×•×œ</button>
                <button class="btn" style="width:auto; margin:0; padding:5px 15px; background:#ff4757;" id="logoutBtn">×”×ª× ×ª×§</button>
            </div>
        </div>
        
        <div id="questions-list">×˜×•×¢×Ÿ ×©××œ×•×ª...</div>
        
        <button class="btn btn-danger" id="deleteDataBtn">××—×§ ××ª ×”×—×©×‘×•×Ÿ ×•×›×œ ×”× ×ª×•× ×™× ×©×œ×™ ğŸ—‘ï¸</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, deleteUser, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, query, where, getDocs, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyDe865bQUEQ_jbNeiXxCK4CfGM7n5Tx9-w", 
        authDomain: "surveyproject-3a831.firebaseapp.com", 
        projectId: "surveyproject-3a831", 
        storageBucket: "surveyproject-3a831.firebasestorage.app", 
        messagingSenderId: "734951066394", 
        appId: "1:734951066394:web:cb6ea73af396618c663aa3" 
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let confirmationResult = null;
    let userVotesMap = {};

    // ×”×’×“×¨×ª reCAPTCHA
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'normal' });

    onAuthStateChanged(auth, async user => {
        if(user) {
            // 1. ×‘×“×™×§×ª ×—×¡×™××” (×‘××Ÿ)
            onSnapshot(doc(db, "bans", user.uid), async s => {
                if(s.exists()) {
                    document.getElementById('ban-screen').style.display = 'block';
                    document.getElementById('app-ui').style.display = 'none';
                    document.getElementById('ban-details').innerText = `×¡×™×‘×”: ${s.data().reason} | ×¢×“: ${s.data().until}`;
                } else {
                    document.getElementById('auth-ui').style.display = 'none';
                    document.getElementById('app-ui').style.display = 'block';
                    document.getElementById('hello').innerText = "×©×œ×•×, " + (user.displayName || user.email || user.phoneNumber);
                    
                    // 2. ×‘×“×™×§×” ×”×× ×”××©×ª××© ×”×•× ××“××™×Ÿ ×›×“×™ ×œ×”×¦×™×’ ××ª ×›×¤×ª×•×¨ ×”× ×™×”×•×œ
                    const adminDoc = await getDoc(doc(db, "admins", user.uid));
                    if(adminDoc.exists()) {
                        document.getElementById('adminBtn').style.display = 'block';
                    }

                    listenToMyVotes(user.uid);
                }
            });
        } else {
            document.getElementById('auth-ui').style.display = 'block';
            document.getElementById('app-ui').style.display = 'none';
            document.getElementById('adminBtn').style.display = 'none';
        }
    });

    // --- ×œ×•×’×™×§×ª ×”×¦×‘×¢×•×ª ---
    function listenToMyVotes(uid) {
        const qVotes = query(collection(db, "votes"), where("uid", "==", uid));
        onSnapshot(qVotes, (snapshot) => {
            userVotesMap = {};
            snapshot.docs.forEach(d => { userVotesMap[d.data().questionId] = d.data().vote; });
            loadSurveys();
        });
    }

    function loadSurveys() {
        onSnapshot(collection(db, "question_bank"), s => {
            const list = document.getElementById('questions-list');
            list.innerHTML = '';
            s.forEach(d => {
                const data = d.data();
                if(!data.isActive) return;
                const myChoice = userVotesMap[d.id];
                let buttonsHtml = data.options.map(o => {
                    const isSel = (o === myChoice) ? 'selected' : '';
                    return `<button class="opt-btn ${isSel}" onclick="window.vote('${d.id}','${o}')">${o}</button>`;
                }).join('');
                list.innerHTML += `<div class="survey-card"><b>${data.text}</b><br>${buttonsHtml}</div>`;
            });
        });
    }

    window.vote = async (qid, val) => {
        const voteId = auth.currentUser.uid + "_" + qid;
        await setDoc(doc(db, "votes", voteId), {
            uid: auth.currentUser.uid,
            name: auth.currentUser.displayName || auth.currentUser.email || auth.currentUser.phoneNumber,
            questionId: qid,
            vote: val,
            lastUpdated: Date.now()
        });
    };

    // --- ××—×™×§×ª × ×ª×•× ×™× ×•×—×©×‘×•×Ÿ ---
    document.getElementById('deleteDataBtn').onclick = async () => {
        if (!confirm("××–×”×¨×”: ×¤×¢×•×œ×” ×–×• ×ª××—×•×§ ××ª ×›×œ ×”×”×¦×‘×¢×•×ª ×©×œ×š ×•××ª ×”×—×©×‘×•×Ÿ ×œ×¦××™×ª×•×ª. ×œ×”××©×™×š?")) return;
        const user = auth.currentUser;
        try {
            const q = query(collection(db, "votes"), where("uid", "==", user.uid));
            const snap = await getDocs(q);
            const delPromises = snap.docs.map(d => deleteDoc(doc(db, "votes", d.id)));
            await Promise.all(delPromises);
            await deleteUser(user);
            alert("×”×—×©×‘×•×Ÿ ×•×”× ×ª×•× ×™× × ××—×§×•.");
        } catch (e) {
            alert("×©×’×™××” ×‘××—×™×§×”: " + e.message + " (×™×™×ª×›×Ÿ ×©×¦×¨×™×š ×œ×”×ª×—×‘×¨ ××—×“×©)");
        }
    };

    // --- ×©×™×˜×•×ª ×”×ª×—×‘×¨×•×ª ---
    document.getElementById('googleBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
    document.getElementById('logoutBtn').onclick = () => signOut(auth);
    
    document.getElementById('loginBtn').onclick = async () => {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        try { await signInWithEmailAndPassword(auth, e, p); } 
        catch { await createUserWithEmailAndPassword(auth, e, p); }
    };

    document.getElementById('sendCodeBtn').onclick = async () => {
        const phoneNumber = document.getElementById('phone').value;
        try {
            confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier);
            document.getElementById('verification-ui').style.display = 'block';
            alert("×§×•×“ × ×©×œ×—!");
        } catch (error) { alert("×©×’×™××”: " + error.message); }
    };

    document.getElementById('verifyCodeBtn').onclick = async () => {
        const code = document.getElementById('verificationCode').value;
        try { await confirmationResult.confirm(code); } 
        catch (error) { alert("×§×•×“ ×©×’×•×™"); }
    };

</script>
</body>
</html>
