<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Survey App | ×’×™×¨×¡×” ×¢× ××—×™×§×ª × ×ª×•× ×™×</title>
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --danger: #ef4444; }
        body { font-family: sans-serif; background: var(--bg); direction: rtl; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 400px; margin: auto; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; background: var(--primary); color: white; margin-top: 10px; }
        .btn-danger { background: var(--danger); margin-top: 20px; font-size: 0.9rem; }
        #ban-screen { display:none; position:fixed; inset:0; background:white; z-index:10000; text-align:center; padding-top:100px; }
        .survey-card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #eee; }
        .opt-btn { width: 100%; text-align: right; padding: 12px; margin: 5px 0; border: 1px solid #e2e8f0; border-radius: 10px; cursor: pointer; background: #fff; transition: 0.3s; }
        .opt-btn.selected { background: #6366f1 !important; color: white; font-weight: bold; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div id="ban-screen">
        <h1 style="color:red">×—×¡×•× ××”××¢×¨×›×ª ğŸš«</h1>
        <div id="ban-details" style="margin-top: 20px;"></div>
    </div>

    <div id="auth-ui" class="card">
        <h2>×›× ×™×¡×” ×œ×¡×§×¨×™×</h2>
        <input type="email" id="email" placeholder="××™××™×™×œ" style="width:100%; padding:10px; margin:5px 0; border-radius:8px; border:1px solid #ddd; box-sizing: border-box;">
        <input type="password" id="pass" placeholder="×¡×™×¡××”" style="width:100%; padding:10px; margin:5px 0; border-radius:8px; border:1px solid #ddd; box-sizing: border-box;">
        <button class="btn" id="loginBtn">×›× ×™×¡×” / ×”×¨×©××”</button>
        <button class="btn" style="background:#4285F4" id="googleBtn">×›× ×™×¡×” ×¢× Google</button>
    </div>

    <div id="app-ui" style="display:none; max-width:500px; margin:auto;">
        <div class="nav-bar">
            <span id="hello" style="font-weight:bold;"></span>
            <button class="btn" style="width:auto; margin:0; padding:5px 15px; background:#ff4757;" id="logoutBtn">×”×ª× ×ª×§</button>
        </div>
        <div id="questions-list">×˜×•×¢×Ÿ ×©××œ×•×ª...</div>
        
        <button class="btn btn-danger" id="deleteDataBtn">××—×§ ××ª ×”××©×ª××© ×©×œ×™ ×•×›×œ ×”× ×ª×•× ×™×</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyDe865bQUEQ_jbNeiXxCK4CfGM7n5Tx9-w", 
        authDomain: "surveyproject-3a831.firebaseapp.com", 
        projectId: "surveyproject-3a831", 
        storageBucket: "surveyproject-3a831.firebasestorage.app", 
        messagingSenderId: "734951066394", 
        appId: "1:734951066394:web:cb6ea73af396618c663aa3" 
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userVotesMap = {};

    onAuthStateChanged(auth, user => {
        if(user) {
            onSnapshot(doc(db, "bans", user.uid), s => {
                if(s.exists()) {
                    document.getElementById('ban-screen').style.display = 'block';
                    document.getElementById('app-ui').style.display = 'none';
                    document.getElementById('ban-details').innerText = `×¡×™×‘×”: ${s.data().reason} | ×©×—×¨×•×¨: ${s.data().until}`;
                } else {
                    document.getElementById('auth-ui').style.display = 'none';
                    document.getElementById('app-ui').style.display = 'block';
                    document.getElementById('hello').innerText = "×©×œ×•×, " + (user.displayName || user.email);
                    listenToMyVotes(user.uid);
                }
            });
        } else {
            document.getElementById('auth-ui').style.display = 'block';
            document.getElementById('app-ui').style.display = 'none';
            document.getElementById('ban-screen').style.display = 'none';
        }
    });

    function listenToMyVotes(uid) {
        const qVotes = query(collection(db, "votes"), where("uid", "==", uid));
        onSnapshot(qVotes, (snapshot) => {
            userVotesMap = {};
            snapshot.docs.forEach(d => { userVotesMap[d.data().questionId] = d.data().vote; });
            loadSurveys();
        });
    }

    function loadSurveys() {
        onSnapshot(collection(db, "question_bank"), s => {
            const list = document.getElementById('questions-list');
            list.innerHTML = '';
            s.forEach(d => {
                const data = d.data();
                if(!data.isActive) return;
                const myChoice = userVotesMap[d.id];
                
                let buttonsHtml = data.options.map(o => {
                    const isSel = (o === myChoice) ? 'selected' : '';
                    return `<button class="opt-btn ${isSel}" onclick="window.vote('${d.id}','${o}')">${o} ${isSel ? 'âœ“' : ''}</button>`;
                }).join('');

                list.innerHTML += `<div class="survey-card"><b>${data.text}</b><br>${buttonsHtml}</div>`;
            });
        });
    }

    window.vote = async (qid, val) => {
        const voteId = auth.currentUser.uid + "_" + qid;
        await setDoc(doc(db, "votes", voteId), {
            uid: auth.currentUser.uid,
            name: auth.currentUser.displayName || auth.currentUser.email,
            questionId: qid,
            vote: val,
            lastUpdated: Date.now()
        });
    };

    // ×¤×•× ×§×¦×™×” ×œ××—×™×§×ª ×›×œ × ×ª×•× ×™ ×”××©×ª××© ××”×“××˜×”×‘×™×™×¡ ×•××—×™×§×ª ×”×—×©×‘×•×Ÿ
    document.getElementById('deleteDataBtn').onclick = async () => {
        if (!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ × ×ª×•× ×™ ×”×”×¦×‘×¢×” ×©×œ×š ×•××ª ×”×—×©×‘×•×Ÿ? ×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.")) return;
        
        const user = auth.currentUser;
        const uid = user.uid;

        try {
            // 1. ××—×™×§×ª ×›×œ ×”×”×¦×‘×¢×•×ª ××”×§×•×œ×§×©×Ÿ votes
            const q = query(collection(db, "votes"), where("uid", "==", uid));
            const querySnapshot = await getDocs(q);
            const deletePromises = querySnapshot.docs.map(d => deleteDoc(doc(db, "votes", d.id)));
            await Promise.all(deletePromises);

            // 2. ××—×™×§×ª ×—×©×‘×•×Ÿ ×”××©×ª××© ×-Authentication
            await deleteUser(user);
            alert("×”×—×©×‘×•×Ÿ ×•×›×œ ×”× ×ª×•× ×™× × ××—×§×• ×‘×”×¦×œ×—×”.");
        } catch (err) {
            alert("×©×’×™××” ×‘××—×™×§×”: " + err.message + "\n×™×™×ª×›×Ÿ ×©×¢×œ×™×š ×œ×”×ª× ×ª×§ ×•×œ×”×ª×—×‘×¨ ××—×“×© ×›×“×™ ×œ×‘×¦×¢ ×¤×¢×•×œ×” ×–×•.");
        }
    };

    document.getElementById('googleBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
    document.getElementById('logoutBtn').onclick = () => signOut(auth);
    document.getElementById('loginBtn').onclick = async () => {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        try { await signInWithEmailAndPassword(auth, e, p); } 
        catch { try { await createUserWithEmailAndPassword(auth, e, p); } catch(err) { alert("×©×’×™××”: " + err.message); } }
    };

</script>
</body>
</html>
