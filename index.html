<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Survey App | ×‘×—×™×¨×” ×’××™×©×”</title>
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); direction: rtl; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 400px; margin: auto; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; background: var(--primary); color: white; margin-top: 10px; }
        #ban-screen { display:none; position:fixed; inset:0; background:white; z-index:10000; text-align:center; padding-top:100px; }
        .survey-card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #eee; }
        
        /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨×™ ×”×¦×‘×¢×” */
        .opt-btn { width: 100%; text-align: right; padding: 12px; margin: 5px 0; border: 1px solid #e2e8f0; border-radius: 10px; cursor: pointer; background: #fff; transition: 0.3s; font-size: 1rem; }
        .opt-btn:hover { background: #f1f5f9; }
        
        /* ×¢×™×¦×•×‘ ×”×ª×©×•×‘×” ×©× ×‘×—×¨×” */
        .opt-btn.selected { 
            background: #6366f1 !important; 
            color: white; 
            border-color: #4f46e5;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }
        .voted-status { font-size: 0.8rem; color: #10b981; margin-top: 5px; display: block; }
    </style>
</head>
<body>

    <div id="ban-screen">
        <h1 style="color:red">×—×¡×•× ××”××¢×¨×›×ª ğŸš«</h1>
        <div id="ban-details" style="margin-top: 20px;"></div>
    </div>

    <div id="auth-ui" class="card">
        <h2>×›× ×™×¡×” ×œ×¡×§×¨×™×</h2>
        <input type="email" id="email" placeholder="××™××™×™×œ" style="width:100%; padding:10px; margin:5px 0; border-radius:8px; border:1px solid #ddd;">
        <input type="password" id="pass" placeholder="×¡×™×¡××”" style="width:100%; padding:10px; margin:5px 0; border-radius:8px; border:1px solid #ddd;">
        <button class="btn" onclick="handleAuth()">×›× ×™×¡×” / ×”×¨×©××”</button>
        <button class="btn" style="background:#4285F4" onclick="loginWithGoogle()">×›× ×™×¡×” ×¢× Google</button>
    </div>

    <div id="app-ui" style="display:none; max-width:500px; margin:auto;">
        <div class="card" style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; padding:15px;">
            <span id="hello" style="font-weight:bold;"></span>
            <button onclick="auth.signOut()" style="background:none; border:1px solid #ddd; padding:5px 10px; border-radius:5px; cursor:pointer;">×™×¦×™××”</button>
        </div>
        <div id="questions-list">×˜×•×¢×Ÿ ×©××œ×•×ª...</div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyDe865bQUEQ_jbNeiXxCK4CfGM7n5Tx9-w", 
        authDomain: "surveyproject-3a831.firebaseapp.com", 
        projectId: "surveyproject-3a831", 
        storageBucket: "surveyproject-3a831.firebasestorage.app", 
        messagingSenderId: "734951066394", 
        appId: "1:734951066394:web:cb6ea73af396618c663aa3" 
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userVotesMap = {}; // ××¤×” ×©×©×•××¨×ª: ××–×”×” ×©××œ×” -> ××” ×”××©×ª××© ×¢× ×”

    onAuthStateChanged(auth, user => {
        if(user) {
            // ×‘×“×™×§×ª ×‘××Ÿ ×‘×–××Ÿ ×××ª
            onSnapshot(doc(db, "bans", user.uid), s => {
                if(s.exists()) {
                    document.getElementById('ban-screen').style.display = 'block';
                    document.getElementById('app-ui').style.display = 'none';
                    document.getElementById('ban-details').innerText = `×¡×™×‘×”: ${s.data().reason} | ×©×—×¨×•×¨: ${s.data().until}`;
                } else {
                    document.getElementById('auth-ui').style.display = 'none';
                    document.getElementById('app-ui').style.display = 'block';
                    document.getElementById('hello').innerText = "×©×œ×•×, " + (user.displayName || user.email);
                    listenToMyVotes();
                }
            });
        } else {
            document.getElementById('auth-ui').style.display = 'block';
            document.getElementById('app-ui').style.display = 'none';
        }
    });

    // ×”××–× ×” ×œ×”×¦×‘×¢×•×ª ×”××™×©×™×•×ª ×©×œ×™ ×›×“×™ ×œ×“×¢×ª ××” ×¡×™×× ×ª×™
    function listenToMyVotes() {
        const qVotes = query(collection(db, "votes"), where("uid", "==", auth.currentUser.uid));
        onSnapshot(qVotes, (snapshot) => {
            userVotesMap = {};
            snapshot.docs.forEach(d => {
                const data = d.data();
                userVotesMap[data.questionId] = data.vote;
            });
            loadSurveys();
        });
    }

    function loadSurveys() {
        onSnapshot(collection(db, "question_bank"), s => {
            const list = document.getElementById('questions-list');
            list.innerHTML = '';
            s.forEach(d => {
                const data = d.data();
                if(!data.isActive) return;

                const myChoice = userVotesMap[d.id]; // ×”×‘×—×™×¨×” ×”× ×•×›×—×™×ª ×©×œ×™ ×œ×©××œ×” ×”×–×•
                
                let buttonsHtml = data.options.map(o => {
                    const isSelected = (o === myChoice) ? 'selected' : '';
                    return `<button class="opt-btn ${isSelected}" onclick="vote('${d.id}','${o}')">
                                ${o} ${isSelected ? ' âœ“' : ''}
                            </button>`;
                }).join('');

                list.innerHTML += `
                    <div class="survey-card">
                        <b style="font-size:1.1rem; display:block; margin-bottom:10px;">${data.text}</b>
                        ${buttonsHtml}
                        ${myChoice ? '<span class="voted-status">× ×™×ª×Ÿ ×œ×©× ×•×ª ××ª ×”×‘×—×™×¨×” ×‘×›×œ ×¢×ª</span>' : ''}
                    </div>`;
            });
        });
    }

    window.vote = async (qid, val) => {
        const voteId = auth.currentUser.uid + "_" + qid;
        await setDoc(doc(db, "votes", voteId), {
            uid: auth.currentUser.uid,
            name: auth.currentUser.displayName || auth.currentUser.email,
            questionId: qid,
            vote: val,
            lastUpdated: Date.now()
        });
    };

    // ×¤×•× ×§×¦×™×•×ª ×”×ª×—×‘×¨×•×ª
    window.handleAuth = async () => {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        try { await signInWithEmailAndPassword(auth, e, p); } 
        catch { try { await createUserWithEmailAndPassword(auth, e, p); } catch(err) { alert("×©×’×™××”: " + err.message); } }
    };
    window.loginWithGoogle = () => signInWithPopup(auth, new GoogleAuthProvider());
</script>
</body>
</html>