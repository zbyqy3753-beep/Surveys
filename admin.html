<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>× ×™×”×•×œ ××¢×¨×›×ª ××œ× | Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; direction: rtl; }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .search-container { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #6366f1; display: flex; gap: 10px; align-items: center; }
        .search-input { flex: 1; border: none; outline: none; font-size: 16px; background: transparent; }
        .category-group { border: 2px solid #3b82f6; padding: 15px; margin-bottom: 20px; background: #f8fafc; border-radius: 12px; min-height: 100px; }
        .category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .category-title { background: #3b82f6; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        .question-item { background: white; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid #eee; cursor: grab; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid #edf2f7; text-align: right; font-size: 13px; }
        .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; color: white; font-weight: bold; font-size: 12px; }
        .btn-red { background: #ef4444; }
        .btn-blue { background: #3b82f6; }
        .btn-green { background: #10b981; }
        .btn-gray { background: #64748b; }
        .bar-bg { background: #e2e8f0; height: 8px; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .bar-fill { background: #3b82f6; height: 100%; border-radius: 5px; }
        .voters-list { font-size: 10px; color: #475569; background: #f1f5f9; padding: 4px; border-radius: 4px; margin-top: 2px; display: none; }
        input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 5px; margin: 2px; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>× ×™×”×•×œ ××¢×¨×›×ª ğŸ› ï¸ (<span id="roleLabel">×˜×•×¢×Ÿ...</span>)</h1>
        <button class="btn btn-blue" onclick="location.href='index.html'">×—×–×¨×” ×œ××ª×¨</button>
    </div>

    <div class="search-container">
        <span>ğŸ”</span>
        <input type="text" id="globalSearch" class="search-input" placeholder="×—×¤×© ×”×›×œ (×©××•×ª, UID, ×©××œ×•×ª, ×”×¦×¢×•×ª)...">
    </div>

    <div class="card" id="ownerOnlyCard">
        <h3>ğŸ‘‘ × ×™×”×•×œ ×¦×•×•×ª ×•××™×¤×•×¡</h3>
        <input type="text" id="adminUid" placeholder="UID ×©×œ ×”××©×ª××©" style="width: 280px;">
        <button class="btn btn-green" id="setAdminBtn">×¢×“×›×Ÿ ××“××™×Ÿ</button>
        <button class="btn btn-red" id="clearAllDataBtn" style="margin-right: 20px;">âš ï¸ ××™×¤×•×¡ ×›×œ×œ×™</button>
    </div>

    <div class="card" id="banListCard">
        <h3>ğŸš« ×—×¡×•××™×</h3>
        <table>
            <thead><tr><th>×©×</th><th>×¡×™×‘×”</th><th>×¤×¢×•×œ×”</th></tr></thead>
            <tbody id="bBody"></tbody>
        </table>
    </div>

    <div class="card" id="usersCard">
        <h3>ğŸ‘¥ ××©×ª××©×™×</h3>
        <table>
            <thead><tr><th>×©×</th><th>UID</th><th>×¤×¢×•×œ×”</th></tr></thead>
            <tbody id="uBody"></tbody>
        </table>
    </div>

    <div class="card" id="suggestionsCard">
        <h3>ğŸ’¡ ×ª×™×‘×ª ×”×¦×¢×•×ª</h3>
        <table>
            <thead><tr><th>×©×</th><th>×”×¨×¢×™×•×Ÿ</th><th>×¤×¢×•×œ×”</th></tr></thead>
            <tbody id="sBody"></tbody>
        </table>
    </div>

    <div class="card" id="statsCard">
        <h3>ğŸ“Š ×¡×§×¨×™× ×•× ×™×”×•×œ × ×•×©××™×</h3>
        <div id="statsContainer">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
    </div>

    <div class="card" id="addQuestionCard">
        <h3>â• ×”×•×¡×¤×ª ×©××œ×”</h3>
        <input type="text" id="nCategory" placeholder="× ×•×©×">
        <input type="text" id="nq" placeholder="×©××œ×”">
        <input type="text" id="no" placeholder="×ª×©×•×‘×•×ª (×¤×¡×™×§ ×‘×™× ×™×”×Ÿ)">
        <button class="btn btn-blue" id="addBtn">×¤×¨×¡×</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, updateDoc, getDoc, getDocs, query, where, writeBatch, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyDe865bQUEQ_jbNeiXxCK4CfGM7n5Tx9-w", 
        authDomain: "surveyproject-3a831.firebaseapp.com", 
        projectId: "surveyproject-3a831", 
        storageBucket: "surveyproject-3a831.firebasestorage.app", 
        messagingSenderId: "734951066394", 
        appId: "1:734951066394:web:cb6ea73af396618c663aa3" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let searchTerm = "";
    let localData = { questions: [], votes: [], suggestions: [], bans: [], users: {} };

    onAuthStateChanged(auth, async user => {
        if (!user) { window.location.href = 'index.html'; return; }
        const adminDoc = await getDoc(doc(db, "admins", user.uid));
        if (adminDoc.exists()) {
            document.getElementById('roleLabel').innerText = adminDoc.data().role;
            document.querySelectorAll('.card').forEach(c => c.style.display = 'block');
            startListeners();
        }
    });

    function startListeners() {
        onSnapshot(collection(db, "votes"), snap => {
            localData.votes = snap.docs.map(d => d.data());
            localData.votes.forEach(v => { if(v.uid) localData.users[v.uid] = v.name || "×× ×•× ×™××™"; });
            renderAll();
        });
        onSnapshot(collection(db, "question_bank"), snap => {
            localData.questions = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderAll();
        });
        onSnapshot(collection(db, "suggestions"), snap => {
            localData.suggestions = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderAll();
        });
        onSnapshot(collection(db, "bans"), snap => {
            localData.bans = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderAll();
        });
        document.getElementById('globalSearch').oninput = (e) => { searchTerm = e.target.value.toLowerCase(); renderAll(); };
    }

    function renderAll() {
        // ××©×ª××©×™× ×•×—×¡×•××™×
        const uBody = document.getElementById('uBody'); uBody.innerHTML = '';
        Object.keys(localData.users).forEach(uid => {
            if(localData.users[uid].toLowerCase().includes(searchTerm))
                uBody.innerHTML += `<tr><td>${localData.users[uid]}</td><td><small>${uid}</small></td><td><button class="btn btn-red" onclick="applyBan('${uid}','${localData.users[uid]}')">×‘××Ÿ</button> <button class="btn btn-blue" onclick="deleteUserData('${uid}')">××—×§</button></td></tr>`;
        });

        const bBody = document.getElementById('bBody'); bBody.innerHTML = '';
        localData.bans.forEach(b => { if(b.name.toLowerCase().includes(searchTerm)) bBody.innerHTML += `<tr><td>${b.name}</td><td>${b.reason}</td><td><button class="btn btn-green" onclick="removeBan('${b.id}')">×‘×˜×œ ×‘××Ÿ</button></td></tr>`; });

        // ×¨×¢×™×•× ×•×ª ×¢× ××¤×©×¨×•×ª ××—×™×§×”
        const sBody = document.getElementById('sBody'); sBody.innerHTML = '';
        localData.suggestions.forEach(s => {
            if(s.text.toLowerCase().includes(searchTerm))
                sBody.innerHTML += `<tr><td>${s.userName}</td><td>${s.text}</td><td><button class="btn btn-red" onclick="deleteSuggestion('${s.id}')">××—×§</button></td></tr>`;
        });

        // ×§×˜×’×•×¨×™×•×ª
        const container = document.getElementById('statsContainer'); container.innerHTML = '';
        const cats = {};
        localData.questions.forEach(q => {
            const c = q.category || "×›×œ×œ×™";
            if(q.text.toLowerCase().includes(searchTerm) || c.toLowerCase().includes(searchTerm)) {
                if(!cats[c]) cats[c] = [];
                cats[c].push(q);
            }
        });

        Object.keys(cats).forEach(catName => {
            let html = `<div class="category-group" ondragover="event.preventDefault()" ondrop="onDrop(event, '${catName}')">
                <div class="category-header">
                    <span class="category-title">${catName}</span>
                    <button class="btn btn-red" style="font-size:10px" onclick="deleteWholeCategory('${catName}')">ğŸ—‘ï¸ ××—×§ ×”×›×œ ×‘× ×•×©×</button>
                </div>`;
            cats[catName].forEach(q => {
                const qVotes = localData.votes.filter(v => v.questionId === q.id);
                html += `<div class="question-item" draggable="true" ondragstart="event.dataTransfer.setData('qid', '${q.id}')">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b>${q.text}</b>
                        <span>
                            <button class="btn btn-gray" style="font-size:10px" onclick="toggleVoters('${q.id}')">ğŸ‘¤ ×©××•×ª</button>
                            <button class="btn btn-red" style="font-size:10px" onclick="deleteQuestion('${q.id}')">ğŸ—‘ï¸</button>
                        </span>
                    </div>`;
                (q.options || []).forEach(opt => {
                    const voters = qVotes.filter(v => v.vote === opt);
                    const pct = qVotes.length > 0 ? Math.round((voters.length/qVotes.length)*100) : 0;
                    html += `<div style="margin-top:5px; font-size:11px;">${opt} (${voters.length})
                        <div class="bar-bg"><div class="bar-fill" style="width:${pct}%"></div></div>
                        <div class="voters-list v-${q.id}">${voters.map(v=>v.name).join(', ') || '××™×Ÿ'}</div>
                    </div>`;
                });
                html += `</div>`;
            });
            container.innerHTML += html + `</div>`;
        });
    }

    // ×¤×•× ×§×¦×™×•×ª ×’×œ×•×‘×œ×™×•×ª
    window.deleteSuggestion = async (id) => { if(confirm("×œ××—×•×§ ×”×¦×¢×” ×–×•?")) await deleteDoc(doc(db, "suggestions", id)); };
    window.deleteWholeCategory = async (catName) => {
        if(confirm(`×œ××—×•×§ ××ª ×›×œ ×”×©××œ×•×ª ×‘× ×•×©× "${catName}"?`)) {
            const toDelete = localData.questions.filter(q => q.category === catName);
            const batch = writeBatch(db);
            toDelete.forEach(q => batch.delete(doc(db, "question_bank", q.id)));
            await batch.commit();
        }
    };
    window.removeBan = async (id) => await deleteDoc(doc(db, "bans", id));
    window.applyBan = async (uid, name) => { const r = prompt("×¡×™×‘×”:"); if(r) await setDoc(doc(db, "bans", uid), { name, reason: r }); };
    window.deleteUserData = async (uid) => { if(confirm("×œ××—×•×§ ×”×¦×‘×¢×•×ª?")) { const s = await getDocs(query(collection(db, "votes"), where("uid", "==", uid))); const b = writeBatch(db); s.forEach(d => b.delete(d.ref)); await b.commit(); } };
    window.deleteQuestion = async (id) => { if(confirm("×œ××—×•×§?")) await deleteDoc(doc(db, "question_bank", id)); };
    window.toggleVoters = (id) => document.querySelectorAll(`.v-${id}`).forEach(el => el.style.display = el.style.display==='block' ? 'none' : 'block');
    window.onDrop = async (e, nCat) => { const qid = e.dataTransfer.getData("qid"); if(qid) await updateDoc(doc(db, "question_bank", qid), { category: nCat }); };

    document.getElementById('addBtn').onclick = async () => {
        const text = document.getElementById('nq').value, cat = document.getElementById('nCategory').value || "×›×œ×œ×™", opts = document.getElementById('no').value.split(',').map(s=>s.trim());
        if(text) await addDoc(collection(db, "question_bank"), { text, category: cat, options: opts });
    };

    document.getElementById('clearAllDataBtn').onclick = async () => {
        if(confirm("×œ××—×•×§ ×”×›×œ?")) {
            for(let c of ['votes', 'question_bank', 'suggestions']) {
                const s = await getDocs(collection(db, c)); const b = writeBatch(db); s.forEach(d => b.delete(d.ref)); await b.commit();
            }
        }
    };
</script>
</body>
</html>
