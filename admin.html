<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×××©×§ × ×™×”×•×œ | Owner ×”××œ×</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; direction: rtl; }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .category-group { border-right: 4px solid #3b82f6; padding: 10px; margin-bottom: 20px; background: #f8fafc; border-radius: 0 8px 8px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 12px; border-bottom: 1px solid #edf2f7; text-align: right; }
        .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; color: white; font-weight: bold; margin: 2px; }
        .btn-red { background: #ef4444; }
        .btn-blue { background: #3b82f6; }
        .btn-green { background: #10b981; }
        .bar-bg { background: #e2e8f0; height: 10px; border-radius: 5px; margin-top: 5px; width: 100%; }
        .bar-fill { background: #3b82f6; height: 100%; border-radius: 5px; }
        input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 5px; margin: 5px; }
        .date-tag { font-size: 11px; color: #64748b; }
        .perm-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; margin: 10px 0; display: flex; gap: 15px; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>× ×™×”×•×œ ××¢×¨×›×ª ğŸ› ï¸ (<span id="roleLabel">×˜×•×¢×Ÿ...</span>)</h1>
        <button class="btn btn-blue" onclick="location.href='index.html'">×—×–×¨×” ×œ××ª×¨</button>
    </div>

    <div class="card" id="ownerOnlyCard">
        <h3>ğŸ‘‘ × ×™×”×•×œ ×¦×•×•×ª ×•×”×’×“×¨×•×ª ××¢×¨×›×ª</h3>
        <input type="text" id="adminUid" placeholder="UID ×©×œ ×”××©×ª××©" style="width: 250px;">
        <div class="perm-box">
            <label><input type="checkbox" class="role-check" value="QUESTIONS"> ×©××œ×•×ª</label>
            <label><input type="checkbox" class="role-check" value="BANS"> ×‘×× ×™×</label>
            <label><input type="checkbox" class="role-check" value="STATS"> ×¡×˜×˜×™×¡×˜×™×§×”</label>
            <label><input type="checkbox" class="role-check" value="ADMINS"> × ×™×”×•×œ ××“××™× ×™×</label>
        </div>
        <button class="btn btn-green" id="setAdminBtn">×¢×“×›×Ÿ ×”×¨×©××•×ª</button>
        <hr style="opacity: 0.2; margin: 20px 0;">
        <button class="btn btn-red" id="clearAllDataBtn">âš ï¸ ××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ××”××¢×¨×›×ª</button>
    </div>

    <div class="card" id="statsCard">
        <h3>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×” ×•×¢×¨×™×›×ª × ×•×©××™×</h3>
        <div id="statsContainer">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
    </div>

    <div class="card" id="addQuestionCard">
        <h3>â• ×”×•×¡×¤×ª ×©××œ×” ×—×“×©×”</h3>
        <input type="text" id="nCategory" placeholder="× ×•×©× (×œ××©×œ: ××•×›×œ)">
        <input type="text" id="nq" placeholder="×”×©××œ×” ×©×œ×š">
        <input type="text" id="no" placeholder="×ª×©×•×‘×•×ª ××•×¤×¨×“×•×ª ×‘×¤×¡×™×§ (×›×Ÿ, ×œ×, ××•×œ×™)">
        <button class="btn btn-blue" id="addBtn">×¦×•×¨ ×©××œ×”</button>
    </div>

    <div class="card" id="voteActionCard">
        <h3>ğŸ—³ï¸ ×”×¦×‘×¢×•×ª ××—×¨×•× ×•×ª ×•× ×™×”×•×œ ××©×ª××©×™×</h3>
        <table>
            <thead><tr><th>×ª××¨×™×š</th><th>×©×</th><th>×ª×©×•×‘×”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
            <tbody id="vBody"></tbody>
        </table>
    </div>

    <div class="card" id="banListCard">
        <h3>ğŸš« ×¨×©×™××ª ×—×¡×•××™×</h3>
        <table>
            <thead><tr><th>×©×</th><th>×¡×™×‘×”</th><th>×¤×¢×•×œ×”</th></tr></thead>
            <tbody id="bBody"></tbody>
        </table>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, updateDoc, getDoc, getDocs, query, where, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyDe865bQUEQ_jbNeiXxCK4CfGM7n5Tx9-w", 
        authDomain: "surveyproject-3a831.firebaseapp.com", 
        projectId: "surveyproject-3a831", 
        storageBucket: "surveyproject-3a831.firebasestorage.app", 
        messagingSenderId: "734951066394", 
        appId: "1:734951066394:web:cb6ea73af396618c663aa3" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ×—×©×™×¤×ª ×¤×•× ×§×¦×™×•×ª ×œ×—×œ×•×Ÿ ×”×’×œ×•×‘×œ×™ ×›×“×™ ×©×”×›×¤×ª×•×¨×™× ×‘-HTML ×™×¢×‘×“×•
    window.applyBan = async (uid, name) => {
        const reason = document.getElementById(`res_${uid}`).value || "×”×¤×¨×ª ×›×œ×œ×™×";
        await setDoc(doc(db, "bans", uid), { name, reason, createdAt: serverTimestamp() });
        alert("×”××©×ª××© × ×—×¡×!");
    };

    window.removeBan = async (uid) => {
        await deleteDoc(doc(db, "bans", uid));
    };

    window.deleteUserData = async (uid) => {
        if(!confirm("×œ××—×•×§ ××ª ×›×œ ×”×”×¦×‘×¢×•×ª ×©×œ ××©×ª××© ×–×”?")) return;
        const q = query(collection(db, "votes"), where("uid", "==", uid));
        const snap = await getDocs(q);
        const batch = writeBatch(db);
        snap.forEach(d => batch.delete(d.ref));
        await batch.commit();
        alert("× ×ª×•× ×™ ×”××©×ª××© × ××—×§×• ××”××¢×¨×›×ª [cite: 2025-12-17]");
    };

    window.deleteQuestion = async (id) => {
        if(confirm("×œ××—×•×§ ×©××œ×” ×–×•?")) await deleteDoc(doc(db, "question_bank", id));
    };

    onAuthStateChanged(auth, async user => {
        if (!user) { window.location.href = 'index.html'; return; }
        const adminDoc = await getDoc(doc(db, "admins", user.uid));
        
        if (adminDoc.exists()) {
            const data = adminDoc.data();
            // ×©×™××•×© ×‘××¢×¨×š ×”×”×¨×©××•×ª ××”-Database
            const perms = data.role === 'owner' ? ['QUESTIONS', 'BANS', 'STATS', 'ADMINS'] : (data.permissions || []);
            
            document.getElementById('roleLabel').innerText = data.role === 'owner' ? "Owner" : "××“××™×Ÿ ××•×ª××";

            if (perms.includes('STATS')) document.getElementById('statsCard').style.display = 'block';
            if (perms.includes('QUESTIONS')) document.getElementById('addQuestionCard').style.display = 'block';
            if (perms.includes('BANS')) {
                document.getElementById('banListCard').style.display = 'block';
                document.getElementById('voteActionCard').style.display = 'block';
            }
            if (perms.includes('ADMINS')) document.getElementById('ownerOnlyCard').style.display = 'block';

            startApp(perms);
        }
    });

    function startApp(myPerms) {
        const formatDate = (ts) => ts ? (ts.toDate ? ts.toDate().toLocaleString('he-IL') : new Date(ts).toLocaleString('he-IL')) : "---";

        // ×˜×¢×™× ×ª ×©××œ×•×ª ×•×¡×˜×˜×™×¡×˜×™×§×”
        onSnapshot(collection(db, "question_bank"), snap => {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '';
            const questions = snap.docs.map(d => ({id: d.id, ...d.data()}));
            
            onSnapshot(collection(db, "votes"), voteSnap => {
                const allVotes = voteSnap.docs.map(d => d.data());
                const categories = [...new Set(questions.map(q => q.category || "×›×œ×œ×™"))];

                categories.forEach(cat => {
                    let html = `<div class="category-group"><h4>× ×•×©×: ${cat}</h4>`;
                    questions.filter(q => (q.category || "×›×œ×œ×™") === cat).forEach(q => {
                        const qVotes = allVotes.filter(v => v.questionId === q.id);
                        html += `<div style="background:white; padding:10px; margin-top:10px; border-radius:5px; position:relative;">
                            <b>${q.text}</b>
                            ${myPerms.includes('QUESTIONS') ? `<button class="btn btn-red" style="position:absolute; left:10px; top:10px;" onclick="deleteQuestion('${q.id}')">ğŸ—‘ï¸</button>` : ''}
                            <br><span class="date-tag">×§×•×œ×•×ª: ${qVotes.length}</span>`;
                        (q.options || []).forEach(opt => {
                            const count = qVotes.filter(v => v.vote === opt).length;
                            const pct = qVotes.length > 0 ? Math.round((count/qVotes.length)*100) : 0;
                            html += `<div style="font-size:12px; margin-top:5px;">${opt} (${count})<div class="bar-bg"><div class="bar-fill" style="width:${pct}%"></div></div></div>`;
                        });
                        html += `</div>`;
                    });
                    container.innerHTML += html + `</div>`;
                });

                // ×˜×¢×™× ×ª ×”×¦×‘×¢×•×ª ×œ×˜×‘×œ×”
                const vBody = document.getElementById('vBody');
                vBody.innerHTML = '';
                allVotes.slice(0, 20).forEach(v => {
                    vBody.innerHTML += `<tr>
                        <td><span class="date-tag">${formatDate(v.createdAt)}</span></td>
                        <td>${v.name}</td>
                        <td>${v.vote}</td>
                        <td>
                            <input type="text" id="res_${v.uid}" placeholder="×¡×™×‘×”" style="width:80px">
                            <button class="btn btn-red" onclick="applyBan('${v.uid}','${v.name}')">×‘××Ÿ</button>
                            <button class="btn btn-blue" onclick="deleteUserData('${v.uid}')">××—×§ × ×ª×•× ×™×</button>
                        </td>
                    </tr>`;
                });
            });
        });

        // ×˜×¢×™× ×ª ×¨×©×™××ª ×‘×× ×™×
        onSnapshot(collection(db, "bans"), snap => {
            const bBody = document.getElementById('bBody');
            bBody.innerHTML = '';
            snap.forEach(d => {
                const b = d.data();
                bBody.innerHTML += `<tr><td>${b.name}</td><td>${b.reason}</td><td><button class="btn btn-green" onclick="removeBan('${d.id}')">×©×—×¨×¨</button></td></tr>`;
            });
        });

        // ×›×¤×ª×•×¨ ××™×¤×•×¡ ×›×œ ×”××¢×¨×›×ª
        document.getElementById('clearAllDataBtn').onclick = async () => {
            if(!confirm("×–×”×™×¨×•×ª! ×–×” ×™××—×§ ××ª ×›×œ ×”×”×¦×‘×¢×•×ª ×•×”×©××œ×•×ª ××”××¢×¨×›×ª [cite: 2025-12-17]")) return;
            const cols = ['votes', 'question_bank'];
            for(const col of cols) {
                const snap = await getDocs(collection(db, col));
                const batch = writeBatch(db);
                snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
            }
            alert("×”××¢×¨×›×ª ××•×¤×¡×” ×œ×—×œ×•×˜×™×Ÿ");
        };

        // ×”×•×¡×¤×ª ××“××™×Ÿ ×—×“×©
        document.getElementById('setAdminBtn').onclick = async () => {
            const uid = document.getElementById('adminUid').value.trim();
            const selected = Array.from(document.querySelectorAll('.role-check:checked')).map(c => c.value);
            if(!uid) return alert("×”×›× ×¡ UID");
            await setDoc(doc(db, "admins", uid), { permissions: selected, role: 'custom' }, { merge: true });
            alert("×”×”×¨×©××•×ª ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”!");
        };

        // ×”×•×¡×¤×ª ×©××œ×”
        document.getElementById('addBtn').onclick = async () => {
            const text = document.getElementById('nq').value;
            const cat = document.getElementById('nCategory').value || "×›×œ×œ×™";
            const opts = document.getElementById('no').value.split(',').map(s => s.trim());
            if(!text || opts.length < 2) return alert("××œ× ×©××œ×” ×•×œ×¤×—×•×ª 2 ×ª×©×•×‘×•×ª");
            await setDoc(doc(db, "question_bank", "q_" + Date.now()), { text, category: cat, options: opts, createdAt: serverTimestamp() });
            alert("×”×©××œ×” × ×•×¡×¤×”!");
        };
    }
</script>
</body>
</html>
