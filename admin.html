<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>× ×™×”×•×œ ××¢×¨×›×ª | ×œ×•×— ×‘×§×¨×” ××œ×</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; direction: rtl; }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .category-group { border-right: 4px solid #3b82f6; padding: 10px; margin-bottom: 20px; background: #f8fafc; border-radius: 0 8px 8px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 12px; border-bottom: 1px solid #edf2f7; text-align: right; }
        .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; color: white; font-weight: bold; margin: 2px; }
        .btn-red { background: #ef4444; }
        .btn-blue { background: #3b82f6; }
        .btn-green { background: #10b981; }
        .btn-purple { background: #8b5cf6; }
        .bar-bg { background: #e2e8f0; height: 10px; border-radius: 5px; margin-top: 5px; width: 100%; }
        .bar-fill { background: #3b82f6; height: 100%; border-radius: 5px; }
        input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 5px; margin: 5px; }
        .date-tag { font-size: 11px; color: #64748b; }
        .perm-box { background: #f8fafc; padding: 10px; border-radius: 8px; display: flex; gap: 15px; margin: 10px 0; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>× ×™×”×•×œ ××¢×¨×›×ª ğŸ› ï¸ (<span id="roleLabel">×˜×•×¢×Ÿ...</span>)</h1>
        <button class="btn btn-blue" onclick="location.href='index.html'">×—×–×¨×” ×œ××ª×¨</button>
    </div>

    <div class="card" id="ownerOnlyCard">
        <h3>ğŸ‘‘ × ×™×”×•×œ ×¦×•×•×ª ×•×”×’×“×¨×•×ª ××¢×¨×›×ª</h3>
        <input type="text" id="adminUid" placeholder="UID ×©×œ ×”××©×ª××©" style="width: 250px;">
        <div class="perm-box">
            <label><input type="checkbox" class="role-check" value="QUESTIONS"> ×©××œ×•×ª</label>
            <label><input type="checkbox" class="role-check" value="BANS"> ×‘×× ×™×</label>
            <label><input type="checkbox" class="role-check" value="STATS"> ×¡×˜×˜×™×¡×˜×™×§×”</label>
            <label><input type="checkbox" class="role-check" value="ADMINS"> × ×™×”×•×œ ××“××™× ×™×</label>
        </div>
        <button class="btn btn-green" id="setAdminBtn">×¢×“×›×Ÿ ×”×¨×©××•×ª</button>
        <hr style="opacity: 0.2; margin: 20px 0;">
        <button class="btn btn-red" id="clearAllDataBtn">âš ï¸ ××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× (××™×¤×•×¡ ××¢×¨×›×ª)</button>
    </div>

    <div class="card" id="suggestionsCard" style="border: 2px solid #8b5cf6;">
        <h3 style="color:#8b5cf6;">ğŸ’¡ ×¨×¢×™×•× ×•×ª ×œ×¡×§×¨×™× ××”×’×•×œ×©×™×</h3>
        <table>
            <thead><tr><th>×©×</th><th>×”×¨×¢×™×•×Ÿ</th><th>×ª××¨×™×š</th><th>×¤×¢×•×œ×”</th></tr></thead>
            <tbody id="sBody"></tbody>
        </table>
    </div>

    <div class="card" id="statsCard">
        <h3>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×” ×•×¢×¨×™×›×ª × ×•×©××™×</h3>
        <div id="statsContainer">×˜×•×¢×Ÿ...</div>
    </div>

    <div class="card" id="addQuestionCard">
        <h3>â• ×”×•×¡×¤×ª ×©××œ×” ×—×“×©×”</h3>
        <input type="text" id="nCategory" placeholder="× ×•×©×">
        <input type="text" id="nq" placeholder="×©××œ×”">
        <input type="text" id="no" placeholder="×ª×©×•×‘×•×ª (×¢× ×¤×¡×™×§)">
        <button class="btn btn-blue" id="addBtn">×¦×•×¨ ×©××œ×”</button>
    </div>

    <div class="card" id="voteActionCard">
        <h3>ğŸ—³ï¸ ×”×¦×‘×¢×•×ª ×•×‘×™×¦×•×¢ ×‘××Ÿ</h3>
        <table>
            <thead><tr><th>×ª××¨×™×š</th><th>×©×</th><th>×ª×©×•×‘×”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
            <tbody id="vBody"></tbody>
        </table>
    </div>

    <div class="card" id="banListCard">
        <h3>ğŸš« × ×™×”×•×œ ×—×¡×•××™× (Bans)</h3>
        <table>
            <thead><tr><th>×©×</th><th>×¡×™×‘×”</th><th>×¤×¢×•×œ×”</th></tr></thead>
            <tbody id="bBody"></tbody>
        </table>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, updateDoc, getDoc, getDocs, query, where, writeBatch, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyDe865bQUEQ_jbNeiXxCK4CfGM7n5Tx9-w", 
        authDomain: "surveyproject-3a831.firebaseapp.com", 
        projectId: "surveyproject-3a831", 
        storageBucket: "surveyproject-3a831.firebasestorage.app", 
        messagingSenderId: "734951066394", 
        appId: "1:734951066394:web:cb6ea73af396618c663aa3" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- ×¤×•× ×§×¦×™×•×ª ×’×œ×•×‘×œ×™×•×ª ×œ×›×¤×ª×•×¨×™× ---
    window.applyBan = async (uid, name) => {
        const reason = document.getElementById(`res_${uid}`).value || "×”×¤×¨×ª ×›×œ×œ×™×";
        await setDoc(doc(db, "bans", uid), { name, reason, until: "×œ×¦××™×ª×•×ª", createdAt: serverTimestamp() });
        alert("× ×—×¡×!");
    };

    window.removeBan = async (id) => await deleteDoc(doc(db, "bans", id));

    window.deleteUserData = async (uid) => {
        if(!confirm("××—×§ ××ª ×›×œ ×”×”×¦×‘×¢×•×ª ×©×œ ××©×ª××© ×–×”?")) return;
        const q = query(collection(db, "votes"), where("uid", "==", uid));
        const snap = await getDocs(q);
        const batch = writeBatch(db);
        snap.forEach(d => batch.delete(d.ref));
        await batch.commit();
        alert("× ×ª×•× ×™ ×”××©×ª××© × ××—×§×•");
    };

    window.deleteQuestion = async (id) => {
        if(confirm("×œ××—×•×§ ×©××œ×” ×–×•?")) await deleteDoc(doc(db, "question_bank", id));
    };

    window.deleteSuggestion = async (id) => {
        if(confirm("×œ××—×•×§ ×¨×¢×™×•×Ÿ ×–×”?")) await deleteDoc(doc(db, "suggestions", id));
    };

    // --- × ×™×”×•×œ ×”×¨×©××•×ª ×•×›× ×™×¡×” ---
    onAuthStateChanged(auth, async user => {
        if (!user) { window.location.href = 'index.html'; return; }
        const adminDoc = await getDoc(doc(db, "admins", user.uid));
        if (adminDoc.exists()) {
            const data = adminDoc.data();
            const perms = data.role === 'owner' ? ['QUESTIONS', 'BANS', 'STATS', 'ADMINS'] : (data.permissions || []);
            document.getElementById('roleLabel').innerText = data.role === 'owner' ? "Owner" : "××“××™×Ÿ";

            if (perms.includes('STATS')) document.getElementById('statsCard').style.display = 'block';
            if (perms.includes('QUESTIONS')) document.getElementById('addQuestionCard').style.display = 'block';
            if (perms.includes('BANS')) {
                document.getElementById('banListCard').style.display = 'block';
                document.getElementById('voteActionCard').style.display = 'block';
            }
            if (perms.includes('ADMINS')) {
                document.getElementById('ownerOnlyCard').style.display = 'block';
                document.getElementById('suggestionsCard').style.display = 'block';
            }
            startApp(perms);
        }
    });

    function startApp(myPerms) {
        const formatDate = (ts) => ts ? (ts.toDate ? ts.toDate().toLocaleString('he-IL') : new Date(ts).toLocaleString('he-IL')) : "---";

        // ×˜×¢×™× ×ª ×¨×¢×™×•× ×•×ª
        onSnapshot(collection(db, "suggestions"), snap => {
            const sBody = document.getElementById('sBody');
            sBody.innerHTML = '';
            snap.forEach(d => {
                const s = d.data();
                sBody.innerHTML += `<tr><td>${s.userName || '×× ×•× ×™××™'}</td><td>${s.text}</td><td>${formatDate(s.createdAt)}</td><td><button class="btn btn-red" onclick="deleteSuggestion('${d.id}')">××—×§</button></td></tr>`;
            });
        });

        // ×˜×¢×™× ×ª ×©××œ×•×ª ×•×¡×˜×˜×™×¡×˜×™×§×”
        onSnapshot(collection(db, "question_bank"), snap => {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '';
            const questions = snap.docs.map(d => ({id: d.id, ...d.data()}));
            onSnapshot(collection(db, "votes"), vSnap => {
                const allVotes = vSnap.docs.map(d => d.data());
                const categories = [...new Set(questions.map(q => q.category || "×›×œ×œ×™"))];
                categories.forEach(cat => {
                    let html = `<div class="category-group"><h4>× ×•×©×: ${cat}</h4>`;
                    questions.filter(q => (q.category || "×›×œ×œ×™") === cat).forEach(q => {
                        const qVotes = allVotes.filter(v => v.questionId === q.id);
                        html += `<div style="background:white; padding:10px; margin-top:10px; border-radius:5px; position:relative;">
                            <b>${q.text}</b> <button class="btn btn-red" style="font-size:10px; float:left" onclick="deleteQuestion('${q.id}')">ğŸ—‘ï¸</button><br>`;
                        (q.options || []).forEach(opt => {
                            const count = qVotes.filter(v => v.vote === opt).length;
                            const pct = qVotes.length > 0 ? Math.round((count/qVotes.length)*100) : 0;
                            html += `<div style="font-size:11px; margin-top:4px;">${opt} (${count})<div class="bar-bg"><div class="bar-fill" style="width:${pct}%"></div></div></div>`;
                        });
                        html += `</div>`;
                    });
                    container.innerHTML += html + `</div>`;
                });

                // ×˜×‘×œ×ª ×”×¦×‘×¢×•×ª
                const vBody = document.getElementById('vBody');
                vBody.innerHTML = '';
                allVotes.slice(0, 20).forEach(v => {
                    vBody.innerHTML += `<tr><td><span class="date-tag">${formatDate(v.createdAt)}</span></td><td>${v.name}</td><td>${v.vote}</td>
                        <td><input type="text" id="res_${v.uid}" placeholder="×¡×™×‘×”" style="width:60px">
                        <button class="btn btn-red" onclick="applyBan('${v.uid}','${v.name}')">×‘××Ÿ</button>
                        <button class="btn btn-blue" style="font-size:10px" onclick="deleteUserData('${v.uid}')">××—×§ × ×ª×•× ×™×</button></td></tr>`;
                });
            });
        });

        // ×¨×©×™××ª ×—×¡×•××™×
        onSnapshot(collection(db, "bans"), snap => {
            const bBody = document.getElementById('bBody');
            bBody.innerHTML = '';
            snap.forEach(d => {
                const b = d.data();
                bBody.innerHTML += `<tr><td>${b.name}</td><td>${b.reason}</td><td><button class="btn btn-green" onclick="removeBan('${d.id}')">×©×—×¨×¨</button></td></tr>`;
            });
        });

        // ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×”
        document.getElementById('clearAllDataBtn').onclick = async () => {
            if(!confirm("××–×”×¨×”: ××—×™×§×ª ×›×œ ×”×”×¦×‘×¢×•×ª ×•×”×©××œ×•×ª ××”××¢×¨×›×ª!")) return;
            for (let col of ['votes', 'question_bank', 'suggestions']) {
                const snap = await getDocs(collection(db, col));
                const batch = writeBatch(db);
                snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
            }
            alert("×”××¢×¨×›×ª ××•×¤×¡×”");
        };

        document.getElementById('setAdminBtn').onclick = async () => {
            const uid = document.getElementById('adminUid').value.trim();
            const selected = Array.from(document.querySelectorAll('.role-check:checked')).map(c => c.value);
            if(uid) await setDoc(doc(db, "admins", uid), { permissions: selected, role: 'custom' }, { merge: true });
            alert("×¢×•×“×›×Ÿ");
        };

        document.getElementById('addBtn').onclick = async () => {
            const text = document.getElementById('nq').value, cat = document.getElementById('nCategory').value || "×›×œ×œ×™", opts = document.getElementById('no').value.split(',').map(s => s.trim());
            if(text) await addDoc(collection(db, "question_bank"), { text, category: cat, options: opts, createdAt: serverTimestamp() });
            alert("× ×•×¡×£");
        };
    }
</script>
</body>
</html>
