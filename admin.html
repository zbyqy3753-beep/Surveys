<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>× ×™×”×•×œ ××¢×¨×›×ª ××œ× | ×œ×•×— ×‘×§×¨×”</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; direction: rtl; }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        
        .category-group { border: 2px solid #3b82f6; padding: 15px; margin-bottom: 20px; background: #f8fafc; border-radius: 12px; min-height: 80px; }
        .category-group.drag-over { background: #e0e7ff; border-style: dashed; }
        .category-title { background: #3b82f6; color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; margin-bottom: 10px; font-weight: bold; }
        
        .question-item { background: white; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid #eee; cursor: grab; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #edf2f7; text-align: right; font-size: 13px; }
        
        .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; color: white; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .btn-red { background: #ef4444; }
        .btn-blue { background: #3b82f6; }
        .btn-green { background: #10b981; }
        .btn-purple { background: #8b5cf6; }
        .btn-small { padding: 2px 6px; font-size: 10px; background: #64748b; margin-right: 5px; }

        .bar-bg { background: #e2e8f0; height: 8px; border-radius: 5px; margin-top: 5px; }
        .bar-fill { background: #3b82f6; height: 100%; border-radius: 5px; }
        
        .voters-list { font-size: 10px; color: #475569; background: #f1f5f9; padding: 4px; border-radius: 4px; margin-top: 2px; display: none; }
        
        input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 5px; margin: 2px; }
        .perm-box { background: #f1f5f9; padding: 10px; border-radius: 8px; display: flex; gap: 10px; margin: 10px 0; font-size: 13px; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>× ×™×”×•×œ ××¢×¨×›×ª ğŸ› ï¸ (<span id="roleLabel">×˜×•×¢×Ÿ...</span>)</h1>
        <button class="btn btn-blue" onclick="location.href='index.html'">×—×–×¨×” ×œ××ª×¨</button>
    </div>

    <div class="card" id="ownerOnlyCard">
        <h3>ğŸ‘‘ × ×™×”×•×œ ×¦×•×•×ª ×•×”×’×“×¨×•×ª ××‘</h3>
        <input type="text" id="adminUid" placeholder="UID ×©×œ ×”××©×ª××©" style="width: 280px;">
        <div class="perm-box">
            <label><input type="checkbox" class="role-check" value="QUESTIONS"> ×©××œ×•×ª</label>
            <label><input type="checkbox" class="role-check" value="BANS"> ×‘×× ×™×</label>
            <label><input type="checkbox" class="role-check" value="STATS"> ×¡×˜×˜×™×¡×˜×™×§×”</label>
            <label><input type="checkbox" class="role-check" value="ADMINS"> × ×™×”×•×œ ××“××™× ×™×</label>
        </div>
        <button class="btn btn-green" id="setAdminBtn">×¢×“×›×Ÿ ×”×¨×©××•×ª ××“××™×Ÿ</button>
        <button class="btn btn-red" id="clearAllDataBtn" style="margin-right: 20px;">âš ï¸ ××™×¤×•×¡ ×›×œ×œ×™</button>
    </div>

    <div class="card" id="usersCard">
        <h3>ğŸ‘¥ ××©×ª××©×™× (UID)</h3>
        <table>
            <thead><tr><th>×©×</th><th>UID</th><th>×¤×¢×•×œ×”</th></tr></thead>
            <tbody id="uBody"></tbody>
        </table>
    </div>

    <div class="card" id="suggestionsCard">
        <h3 style="color:#8b5cf6;">ğŸ’¡ ×¨×¢×™×•× ×•×ª ××”×’×•×œ×©×™×</h3>
        <table><tbody id="sBody"></tbody></table>
    </div>

    <div class="card" id="statsCard">
        <h3>ğŸ“Š ×¡×§×¨×™× ×•×¤×™×¨×•×˜ ×”×¦×‘×¢×•×ª</h3>
        <div id="statsContainer">×˜×•×¢×Ÿ...</div>
    </div>

    <div class="card" id="addQuestionCard">
        <h3>â• ×”×•×¡×¤×ª ×©××œ×” ×—×“×©×”</h3>
        <input type="text" id="nCategory" placeholder="× ×•×©×">
        <input type="text" id="nq" placeholder="×©××œ×”">
        <input type="text" id="no" placeholder="×ª×©×•×‘×•×ª (××•×¤×¨×“×•×ª ×‘×¤×¡×™×§)">
        <button class="btn btn-blue" id="addBtn">×¤×¨×¡× ×¡×§×¨</button>
    </div>

    <div class="card" id="banListCard">
        <h3>ğŸš« × ×™×”×•×œ ×—×¡×•××™×</h3>
        <table><tbody id="bBody"></tbody></table>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, updateDoc, getDoc, getDocs, query, where, writeBatch, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyDe865bQUEQ_jbNeiXxCK4CfGM7n5Tx9-w", 
        authDomain: "surveyproject-3a831.firebaseapp.com", 
        projectId: "surveyproject-3a831", 
        storageBucket: "surveyproject-3a831.firebasestorage.app", 
        messagingSenderId: "734951066394", 
        appId: "1:734951066394:web:cb6ea73af396618c663aa3" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- ×¤×•× ×§×¦×™×•×ª ×ª×¦×•×’×” ×—×“×©×•×ª ---
    window.toggleVoters = (qid) => {
        const elements = document.querySelectorAll(`.voters-${qid}`);
        elements.forEach(el => el.style.display = el.style.display === 'block' ? 'none' : 'block');
    };

    window.editCategory = async (qid, current) => {
        const n = prompt("× ×•×©× ×—×“×©:", current);
        if(n) await updateDoc(doc(db, "question_bank", qid), { category: n });
    };

    window.deleteQuestion = async (id) => { if(confirm("×œ××—×•×§?")) await deleteDoc(doc(db, "question_bank", id)); };
    
    window.deleteUserData = async (uid) => {
        if(!confirm("×œ××—×•×§ ××ª ×›×œ × ×ª×•× ×™ ×”××©×ª××©?")) return;
        const q = query(collection(db, "votes"), where("uid", "==", uid));
        const snap = await getDocs(q);
        const batch = writeBatch(db);
        snap.forEach(d => batch.delete(d.ref));
        await batch.commit();
        alert("× ××—×§");
    };

    window.applyBan = async (uid, name) => {
        const r = prompt("×¡×™×‘×ª ×—×¡×™××” ×¢×‘×•×¨ " + name);
        if(r) await setDoc(doc(db, "bans", uid), { name, reason: r, createdAt: serverTimestamp() });
    };

    window.removeBan = async (id) => await deleteDoc(doc(db, "bans", id));

    // ×’×¨×™×¨×”
    window.onDragStart = (e, qid) => e.dataTransfer.setData("qid", qid);
    window.allowDrop = (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); };
    window.onDragLeave = (e) => e.currentTarget.classList.remove('drag-over');
    window.onDrop = async (e, nCat) => {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        const qid = e.dataTransfer.getData("qid");
        if(qid) await updateDoc(doc(db, "question_bank", qid), { category: nCat });
    };

    onAuthStateChanged(auth, async user => {
        if (!user) { window.location.href = 'index.html'; return; }
        const adminDoc = await getDoc(doc(db, "admins", user.uid));
        if (adminDoc.exists()) {
            const data = adminDoc.data();
            const perms = data.role === 'owner' ? ['QUESTIONS', 'BANS', 'STATS', 'ADMINS'] : (data.permissions || []);
            document.getElementById('roleLabel').innerText = data.role === 'owner' ? "Owner" : "××“××™×Ÿ";
            
            if (perms.includes('STATS')) { document.getElementById('statsCard').style.display = 'block'; document.getElementById('usersCard').style.display = 'block'; }
            if (perms.includes('QUESTIONS')) document.getElementById('addQuestionCard').style.display = 'block';
            if (perms.includes('BANS')) document.getElementById('banListCard').style.display = 'block';
            if (perms.includes('ADMINS')) { document.getElementById('ownerOnlyCard').style.display = 'block'; document.getElementById('suggestionsCard').style.display = 'block'; }
            startApp();
        }
    });

    function startApp() {
        // ×¨×©×™××ª ××©×ª××©×™×
        onSnapshot(collection(db, "votes"), snap => {
            const uBody = document.getElementById('uBody');
            const users = {};
            snap.forEach(d => { users[d.data().uid] = d.data().name; });
            uBody.innerHTML = '';
            Object.keys(users).forEach(uid => {
                uBody.innerHTML += `<tr><td><b>${users[uid]}</b></td><td><small>${uid}</small></td><td>
                    <button class="btn btn-red" onclick="applyBan('${uid}','${users[uid]}')">×‘××Ÿ</button>
                    <button class="btn btn-blue" onclick="deleteUserData('${uid}')">××—×§</button></td></tr>`;
            });
        });

        // ×¡×˜×˜×™×¡×˜×™×§×” ×¢× ×¤×™×¨×•×˜ ×©××•×ª
        onSnapshot(collection(db, "question_bank"), snap => {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '';
            const questions = snap.docs.map(d => ({id: d.id, ...d.data()}));
            
            onSnapshot(collection(db, "votes"), vSnap => {
                const allVotes = vSnap.docs.map(d => d.data());
                const categories = {};
                questions.forEach(q => {
                    const cat = q.category || "×›×œ×œ×™";
                    if(!categories[cat]) categories[cat] = [];
                    categories[cat].push(q);
                });

                Object.keys(categories).forEach(catName => {
                    let html = `<div class="category-group" ondragover="allowDrop(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, '${catName}')">
                        <span class="category-title">${catName}</span>`;
                    
                    categories[catName].forEach(q => {
                        const qVotes = allVotes.filter(v => v.questionId === q.id);
                        html += `<div class="question-item" draggable="true" ondragstart="onDragStart(event, '${q.id}')">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span><b>${q.text}</b></span>
                                <span>
                                    <button class="btn btn-small" onclick="toggleVoters('${q.id}')">ğŸ‘¤ ×”×¦×’×ª ×©××•×ª</button>
                                    <button class="btn btn-blue" style="font-size:9px" onclick="editCategory('${q.id}','${catName}')">× ×•×©×</button>
                                    <button class="btn btn-red" style="font-size:9px" onclick="deleteQuestion('${q.id}')">ğŸ—‘ï¸</button>
                                </span>
                            </div>`;
                        
                        (q.options || []).forEach(opt => {
                            const votersForOpt = qVotes.filter(v => v.vote === opt);
                            const count = votersForOpt.length;
                            const names = votersForOpt.map(v => v.name).join(', ') || "××™×Ÿ ×”×¦×‘×¢×•×ª";
                            const pct = qVotes.length > 0 ? Math.round((count/qVotes.length)*100) : 0;
                            
                            html += `
                                <div style="margin-top:8px;">
                                    <div style="font-size:11px;">${opt} (${count})</div>
                                    <div class="bar-bg"><div class="bar-fill" style="width:${pct}%"></div></div>
                                    <div class="voters-list voters-${q.id}">${names}</div>
                                </div>`;
                        });
                        html += `</div>`;
                    });
                    container.innerHTML += html + `</div>`;
                });
            });
        });

        // ×¨×¢×™×•× ×•×ª
        onSnapshot(collection(db, "suggestions"), snap => {
            const sBody = document.getElementById('sBody'); sBody.innerHTML = '';
            snap.forEach(d => {
                sBody.innerHTML += `<tr><td>${d.data().userName}</td><td>${d.data().text}</td><td><button class="btn btn-red" onclick="deleteDoc(doc(db,'suggestions','${d.id}'))">××—×§</button></td></tr>`;
            });
        });

        // ×—×¡×•××™×
        onSnapshot(collection(db, "bans"), snap => {
            const bBody = document.getElementById('bBody'); bBody.innerHTML = '';
            snap.forEach(d => {
                bBody.innerHTML += `<tr><td>${d.data().name}</td><td>${d.data().reason}</td><td><button class="btn btn-green" onclick="removeBan('${d.id}')">×©×—×¨×¨</button></td></tr>`;
            });
        });

        document.getElementById('addBtn').onclick = async () => {
            const text = document.getElementById('nq').value, cat = document.getElementById('nCategory').value || "×›×œ×œ×™", opts = document.getElementById('no').value.split(',').map(s => s.trim());
            if(text) await addDoc(collection(db, "question_bank"), { text, category: cat, options: opts, createdAt: serverTimestamp() });
        };

        document.getElementById('setAdminBtn').onclick = async () => {
            const uid = document.getElementById('adminUid').value.trim();
            const perms = Array.from(document.querySelectorAll('.role-check:checked')).map(c => c.value);
            if(uid) await setDoc(doc(db, "admins", uid), { permissions: perms, role: 'custom' }, { merge: true });
            alert("×¢×•×“×›×Ÿ!");
        };

        document.getElementById('clearAllDataBtn').onclick = async () => {
            if(confirm("×œ××—×•×§ ×”×›×œ? (×©××œ×•×ª, ×”×¦×‘×¢×•×ª, ×¨×¢×™×•× ×•×ª)")) {
                for (let c of ['votes', 'question_bank', 'suggestions']) {
                    const s = await getDocs(collection(db, c));
                    const b = writeBatch(db);
                    s.forEach(d => b.delete(d.ref));
                    await b.commit();
                }
                alert("×”××¢×¨×›×ª ××•×¤×¡×”");
            }
        };
    }
</script>
</body>
</html>
